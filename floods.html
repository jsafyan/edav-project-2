<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8 />
<title>Flood Map</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<script src='https://api.mapbox.com/mapbox.js/v2.3.0/mapbox.js'></script>
<link href='https://api.mapbox.com/mapbox.js/v2.3.0/mapbox.css' rel='stylesheet' />
<script type="text/javascript" src="flood_info.json"></script>
<style>

  body { 
    margin:0; 
    padding:0;
  }

  #map {
    position:absolute;
    top:0; 
    bottom:0; 
    width:100%;
  }

  .animated-icon {
    width: 10px;
    height: 10px;
    background-color: rgba(255, 48, 44, 0.9);
    border-radius: 50%;
    box-shadow: 0px 0px 4px white;
    transition: all .6s
  }

  .info {
    padding: 10px 10px;
    font: 14px/16px Arial, Helvetica, sans-serif;
    background: white;
    background: rgba(255,255,255,0.8);
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
    border-radius: 5px;
  }

  .info h4 {
    margin: 5 0 5px;
    color: #777;
  }
</style>
</head>
<body>


<div id='map'></div>
<script>
"use strict";
L.mapbox.accessToken = 'pk.eyJ1IjoianNhZnlhbiIsImEiOiJjaWwxYWhxMW4yb3NhdTlrczUzNTRjazg0In0.PLTf10JL0tVwbIpTuaM1jw';
var map = L.mapbox.map('map', 'mapbox.dark', {
	tileLayer: {
        // This map option disables world wrapping. by default, it is false.
        continuousWorld: false,
        // This option disables loading tiles outside of the world bounds.
        noWrap: false
    }
})
    .setView([10, -40.953], 2);


var mydata = JSON.parse(data);
 console.log(mydata);

var start = new Date(473385600000000000 / 1000000);
var end = new Date(1450828800000000000 / 1000000);
const MAX_SQKM= 4814280;
const MAX_DEATHS = 160000;
const MAX_DISPLACED = 40000000;
let i = 0;
var totalDeaths = 0;
var totalDisplaced = 0;

var info = L.control();

info.onAdd = function(map) {
    this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
    this.update();
    return this._div;
};

// method that we will use to update the control based on feature properties passed
info.update = function(date) {
	if (date) {
	  let day = date.getDate();
	  let month = date.getMonth()
	  let year = date.getFullYear();
	  let monthNames = ["January", "February", "March", "April",
    "May", "June", "July", "August", "September", "October", "November", "December"];
	  let html1 = '<h3>' + monthNames[month] + "-" + day + "-" + year + '</h3>';
    let html2 = '<h1>Floods (radius proportional to square kilometers)</h1>';
    let html3 = '<h3>Total Deaths: ' + totalDeaths + ' Total Displaced: ' + totalDisplaced + '</h3>';
	  this._div.innerHTML = "<div style='width:" + 370+ "px;height:" + 80 + "px;overflow:hidden;display:block;padding:0;border:0;margin:0'>" + html2 + html3 + html1 + "</div>";
	}
};

info.addTo(map);

var dayCounter = 0;
function animation_loop() {
	info.update(start)
    plotMarkers(start, dayCounter);
    let date_name = ".id-" + dayCounter;
    expireMarkers(date_name);
    dayCounter += 1;
    setTimeout(function() {
    	let newDate = start.setDate(start.getDate() + 1);
    	start = new Date(newDate);
    	if (start < end) {
    		animation_loop();
    	}
    }, 1);
};
animation_loop();

function plotMarkers(startDate, counter) {
  let i;
  let timestamp = startDate.getTime() * Math.pow(10, 6)
  if (!(timestamp in mydata["Starting"])) {
    return;
  }
  let floods_starting = mydata["Starting"][timestamp];

  for (i = 0; i < floods_starting.length; i++) {
    //update deaths and displaced
    totalDeaths += floods_starting[i]["Dead"];
    totalDisplaced += floods_starting[i]["Displaced"];

    let endStamp = counter + parseInt(floods_starting[i]["Duration"])
    let className = "animated-icon id-" + endStamp;
    const icon = L.divIcon({
        iconSize: [5, 5],
        iconAnchor: [10, 10],
        popupAnchor: [10, 0],
        shadowSize: [0, 0],
        className: className
    })
    var ll = L.latLng(floods_starting[i]["Latitude"], floods_starting[i]["Longitude"])
    // create marker
    var marker = L.marker(ll, {
          icon: icon,
          title: 'This is a flood!'
      })
    let name = ".id-" + (counter + parseInt(floods_starting[i]["Duration"]));
    let sqkm = floods_starting[i]["sqkm"]
    let normalized_size = (sqkm / MAX_SQKM) + 20;
    console.log(normalized_size);
    let normalized_pixels = normalized_size + 'px'
    marker.addTo(map, setTimeout(function(){
    let icons = document.querySelectorAll(name)
    if (icons.length > 0) {
      let i = 0;
      for (i = 0; i < icons.length; i++) {
        icons[i].style.width = normalized_pixels;
        icons[i].style.height = normalized_pixels;
        //Keep things centered when re-sizing
        icons[i].style.marginLeft = 'auto'
        icons[i].style.marginTop = 'auto'
        icons[i].style.backgroundColor = 'rgba(255, 48, 44, 0.7)'
      }
    }}, 0))
  }
}

function expireMarkers(name) {
	let icons = document.querySelectorAll(name)
	let i = 0;
	for (i = 0; i < icons.length; i++) {
		icons[i].style.backgroundColor = 'rgba(192,192,192,0.4)'
    icons[i].style.width = '5px';
    icons[i].style.height = '5px';
	}
}
</script>
</body>
</html>
